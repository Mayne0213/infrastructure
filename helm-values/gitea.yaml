# Gitea Helm Values
# Chart: https://gitea.com/gitea/helm-chart
# Self-hosted Git service

fullnameOverride: gitea

replicaCount: 1

image:
  registry: docker.io
  repository: gitea/gitea
  tag: "1.24.6"
  pullPolicy: IfNotPresent
  rootless: false

# Gitea configuration
gitea:
  admin:
    # Admin credentials managed via environment variables
    existingSecret: gitea-admin-secret

  config:
    server:
      DOMAIN: gitea0213.kro.kr
      ROOT_URL: https://gitea0213.kro.kr
      SSH_DOMAIN: gitea0213.kro.kr
      SSH_PORT: 2222
      DISABLE_SSH: true
      START_SSH_SERVER: false
      SSH_LISTEN_PORT: 2222

    database:
      DB_TYPE: postgres
      HOST: postgresql-primary.postgresql.svc.cluster.local:5432
      NAME: gitea
      USER: postgres
      SCHEMA: public
      SSL_MODE: disable

    service:
      DISABLE_REGISTRATION: false
      REQUIRE_SIGNIN_VIEW: false
      ENABLE_NOTIFY_MAIL: false

    cache:
      ENABLED: true
      ADAPTER: memory

    session:
      PROVIDER: memory

    actions:
      ENABLED: true
      DEFAULT_ACTIONS_URL: https://github.com

    # Storage configuration - use MinIO for attachments and LFS
    storage:
      STORAGE_TYPE: minio
      SERVE_DIRECT: false
      MINIO_ENDPOINT: minio.minio.svc.cluster.local:9000
      MINIO_BUCKET: gitea
      MINIO_LOCATION: us-east-1
      MINIO_USE_SSL: false
      MINIO_INSECURE_SKIP_VERIFY: false

    # LFS (Large File Storage) - use MinIO
    lfs:
      STORAGE_TYPE: minio
      SERVE_DIRECT: false
      MINIO_ENDPOINT: minio.minio.svc.cluster.local:9000
      MINIO_BUCKET: gitea
      MINIO_LOCATION: us-east-1
      MINIO_USE_SSL: false

    # Attachments - use MinIO
    attachment:
      STORAGE_TYPE: minio
      SERVE_DIRECT: false
      MINIO_ENDPOINT: minio.minio.svc.cluster.local:9000
      MINIO_BUCKET: gitea
      MINIO_LOCATION: us-east-1
      MINIO_USE_SSL: false

    # Avatar - use MinIO
    avatar:
      STORAGE_TYPE: minio
      MINIO_ENDPOINT: minio.minio.svc.cluster.local:9000
      MINIO_BUCKET: gitea
      MINIO_LOCATION: us-east-1
      MINIO_USE_SSL: false

# PostgreSQL dependency (using existing PostgreSQL instance)
postgresql:
  enabled: false

# Use existing PostgreSQL
postgresql-ha:
  enabled: false

# Redis (optional, for caching)
redis-cluster:
  enabled: false

# Environment variables for database password and MinIO
deployment:
  env:
    - name: GITEA__database__PASSWD
      valueFrom:
        secretKeyRef:
          name: gitea-postgres-password
          key: password
    # MinIO credentials for storage, LFS, attachments, and avatar
    - name: GITEA__storage__MINIO_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: access-key
    - name: GITEA__storage__MINIO_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: secret-key
    - name: GITEA__lfs__MINIO_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: access-key
    - name: GITEA__lfs__MINIO_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: secret-key
    - name: GITEA__attachment__MINIO_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: access-key
    - name: GITEA__attachment__MINIO_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: secret-key
    - name: GITEA__avatar__MINIO_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: access-key
    - name: GITEA__avatar__MINIO_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: gitea-minio-credentials
          key: secret-key

# Persistence for Gitea data
persistence:
  enabled: true
  size: 10Gi
  storageClass: local-path
  accessModes:
    - ReadWriteOnce

# Service configuration
service:
  http:
    type: ClusterIP
    port: 3000
  ssh:
    type: LoadBalancer
    port: 2222
    externalTrafficPolicy: Local
    annotations:
      metallb.universe.tf/allow-shared-ip: gitea

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
  hosts:
    - host: gitea0213.kro.kr
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: gitea-tls
      hosts:
        - gitea0213.kro.kr

# Resource limits
resources:
  requests:
    cpu: 50m
    memory: 256Mi
  limits:
    memory: 512Mi

# Health checks
livenessProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5

readinessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5

# Security context
securityContext:
  fsGroup: 1000

# Init containers for database setup
initPreScript: |
  #!/bin/sh
  echo "Waiting for PostgreSQL..."
  until nc -z postgresql-primary.postgresql.svc.cluster.local 5432; do
    echo "Waiting for PostgreSQL to be ready..."
    sleep 2
  done
  echo "PostgreSQL is ready"
